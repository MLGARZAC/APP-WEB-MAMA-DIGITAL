<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Control Parental</title>
    <!-- Tailwind CSS CDN para el estilo -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        /* Animaciones para una mejor experiencia de usuario */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .animate-fade-in-up {
            animation: fadeInUp 0.5s ease-out forwards;
        }
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .animate-spin {
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="min-h-screen bg-sky-200 p-4">
    <div id="app-root" class="min-h-screen bg-sky-200 p-4 font-inter">
        <header class="bg-white bg-opacity-70 backdrop-blur-sm rounded-lg shadow-md p-4 mb-6 flex justify-between items-center flex-wrap gap-2">
            <h1 class="text-2xl font-bold text-gray-800">Control Parental</h1>
            <div id="user-id-display" class="text-sm text-gray-600 hidden">
                ID de Usuario: <span class="font-mono bg-gray-100 p-1 rounded break-all"></span>
            </div>
        </header>

        <div id="main-content">
            <!-- El contenido de la aplicaci√≥n (dashboard, perfiles de hijo, formularios) se renderizar√° aqu√≠ din√°micamente por JavaScript -->
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, addDoc, updateDoc, deleteDoc, onSnapshot, query, where, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Variables de Estado Globales ---
        // Estas variables simulan el estado de React en una aplicaci√≥n de JavaScript puro
        let db = null;
        let auth = null;
        let userId = null;
        let isAuthReady = false;
        let loading = true;
        let children = []; // Lista de perfiles de hijos
        let selectedChild = null; // El hijo actualmente seleccionado para ver su perfil
        let currentPage = 'dashboard'; // Controla qu√© vista se muestra ('dashboard', 'childProfile', 'addChildren')
        let currentCalendarMonth = new Date(); // Para la navegaci√≥n del calendario

        // --- Configuraci√≥n de Firebase ---
        // !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
        // !!! ¬°ATENCI√ìN! DEBES REEMPLAZAR ESTOS VALORES CON TU PROPIA CONFIGURACI√ìN DE FIREBASE !!!
        // !!! Puedes encontrar esta informaci√≥n en la Consola de Firebase de tu proyecto (Configuraci√≥n del proyecto -> Tus apps) !!!
        // !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
        const firebaseConfig = {
             apiKey: "TU_API_KEY_DE_FIREBASE", // Ejemplo: "AIzaSyC..."
             authDomain: "TU_AUTH_DOMAIN.firebaseapp.com", // Ejemplo: "mi-app-parental.firebaseapp.com"
             projectId: "TU_PROJECT_ID", // Ejemplo: "mi-app-parental"
             storageBucket: "TU_STORAGE_BUCKET.appspot.com", // Ejemplo: "mi-app-parental.appspot.com"
             messagingSenderId: "TU_MESSAGING_SENDER_ID", // Ejemplo: "1234567890"
             appId: "TU_APP_ID" // Ejemplo: "1:234567890:web:abcdef"
        };

        // Este 'appId' se utiliza para las rutas de las colecciones de Firestore (artifacts/{appId}/...).
        // Si no tienes un __app_id definido por el entorno, usa el appId de tu firebaseConfig.
        const appId = typeof __app_id !== 'undefined' ? __app_id : firebaseConfig.appId || "default-app-id";

        // --- Funciones de Utilidad (Adaptadas de React) ---

        /**
         * Muestra un modal de mensaje personalizado en lugar de alert().
         * @param {string} title - El t√≠tulo del modal.
         * @param {string} message - El mensaje a mostrar.
         */
        const showMessage = (title, message) => {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50';
            modal.innerHTML = `
                <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full text-center">
                    <h3 class="text-lg font-bold mb-4">${title}</h3>
                    <p class="text-gray-700 mb-6">${message}</p>
                    <button id="modal-close-button" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg focus:outline-none focus:shadow-outline">Cerrar</button>
                </div>
            `;
            document.body.appendChild(modal);

            document.getElementById('modal-close-button').onclick = () => {
                document.body.removeChild(modal);
            };
        };

        /**
         * Muestra un modal de confirmaci√≥n personalizado.
         * @param {string} title - El t√≠tulo del modal.
         * @param {string} message - El mensaje a mostrar.
         * @param {function} onConfirm - Funci√≥n a ejecutar si el usuario confirma.
         * @param {function} onCancel - Funci√≥n a ejecutar si el usuario cancela.
         */
        const renderConfirmationModal = (title, message, onConfirm, onCancel) => {
            const modalContainer = document.createElement('div');
            modalContainer.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50';
            modalContainer.innerHTML = `
                <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full text-center">
                    <h3 class="text-lg font-bold mb-4">${title}</h3>
                    <p class="text-gray-700 mb-6">${message}</p>
                    <div class="flex justify-around">
                        <button id="confirm-button" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg focus:outline-none focus:shadow-outline">Confirmar</button>
                        <button id="cancel-button" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg focus:outline-none focus:shadow-outline">Cancelar</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modalContainer);

            document.getElementById('confirm-button').onclick = () => {
                onConfirm();
                document.body.removeChild(modalContainer);
            };
            document.getElementById('cancel-button').onclick = () => {
                onCancel();
                document.body.removeChild(modalContainer);
            };
        };

        // --- L√≥gica Principal de la Aplicaci√≥n ---

        /**
         * Renderiza la interfaz de usuario principal de la aplicaci√≥n.
         * Se llama cada vez que el estado global de la aplicaci√≥n (currentPage, loading, etc.) cambia.
         */
        function renderApp() {
            const mainContent = document.getElementById('main-content');
            if (!mainContent) return;

            mainContent.innerHTML = ''; // Limpia el contenido anterior

            if (loading) {
                mainContent.innerHTML = `
                    <div class="flex items-center justify-center min-h-[calc(100vh-160px)]"> <!-- Ajusta altura para centrar -->
                        <div class="text-xl font-semibold text-gray-700">Cargando aplicaci√≥n...</div>
                    </div>
                `;
                return;
            }

            if (!isAuthReady) {
                mainContent.innerHTML = `
                    <div class="flex items-center justify-center min-h-[calc(100vh-160px)]"> <!-- Ajusta altura para centrar -->
                        <div class="text-xl font-semibold text-red-700">Error: No se pudo autenticar.</div>
                    </div>
                `;
                return;
            }

            // Muestra el ID de usuario en el encabezado
            const userIdDisplay = document.getElementById('user-id-display');
            if (userIdDisplay) {
                userIdDisplay.classList.remove('hidden');
                userIdDisplay.querySelector('span').textContent = userId;
            }

            // Renderiza el componente de p√°gina actual
            if (currentPage === 'dashboard') {
                renderDashboard(mainContent);
            } else if (currentPage === 'childProfile' && selectedChild) {
                renderChildProfile(mainContent, selectedChild);
            } else if (currentPage === 'addChildren') {
                renderAddChildForm(mainContent);
            }
        }

        // --- Componente Dashboard ---
        /**
         * Renderiza la vista del dashboard con la lista de hijos.
         * @param {HTMLElement} container - El elemento DOM donde se renderizar√° el dashboard.
         */
        function renderDashboard(container) {
            const dashboardHtml = `
                <div class="bg-white bg-opacity-80 rounded-lg shadow-xl p-6 md:p-8 max-w-4xl mx-auto">
                    <h2 class="text-xl md:text-2xl font-semibold text-gray-800 mb-6">Perfiles de Hijos</h2>
                    <div id="children-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
                        <!-- Las tarjetas de hijos se insertar√°n aqu√≠ -->
                    </div>
                    <button id="add-child-button"
                        class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg shadow-lg transition duration-300 ease-in-out transform hover:scale-105 flex items-center justify-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth="2">
                            <path strokeLinecap="round" strokeLinejoin="round" d="M12 4v16m8-8H4" />
                        </svg>
                        A√±adir Nuevo Hijo
                    </button>
                </div>
            `;
            container.innerHTML = dashboardHtml;

            const childrenGrid = document.getElementById('children-grid');
            if (children.length > 0) {
                children.forEach(child => {
                    const childCard = document.createElement('div');
                    childCard.className = "bg-blue-100 border border-blue-200 rounded-lg p-5 flex flex-col items-center shadow-md hover:shadow-lg transition-shadow duration-300 cursor-pointer";
                    childCard.innerHTML = `
                        <img src="${child.photoURL || `https://placehold.co/100x100/AEC6CF/FFFFFF?text=${child.name.charAt(0).toUpperCase()}`}"
                            alt="${child.name}"
                            class="w-24 h-24 rounded-full object-cover mb-4 border-2 border-blue-400 shadow-sm"
                            onerror="this.src='https://placehold.co/100x100/AEC6CF/FFFFFF?text=${child.name.charAt(0).toUpperCase()}'"
                        />
                        <h3 class="text-lg font-bold text-gray-900 mb-1">${child.name}</h3>
                        <p class="text-sm text-gray-600">Edad: ${new Date().getFullYear() - new Date(child.dob).getFullYear()}</p>
                    `;
                    childCard.addEventListener('click', () => {
                        selectedChild = child;
                        currentPage = 'childProfile';
                        renderApp(); // Vuelve a renderizar la aplicaci√≥n para mostrar el perfil del hijo
                    });
                    childrenGrid.appendChild(childCard);
                });
            } else {
                childrenGrid.innerHTML = `<p class="col-span-full text-center text-gray-600">No hay perfiles de hijos. ¬°A√±ade uno!</p>`;
            }

            document.getElementById('add-child-button').addEventListener('click', () => {
                currentPage = 'addChildren';
                renderApp(); // Vuelve a renderizar la aplicaci√≥n para mostrar el formulario de a√±adir hijo
            });
        }

        // --- Componente Add/Edit Child Form ---
        /**
         * Renderiza el formulario para a√±adir o editar un perfil de hijo.
         * @param {HTMLElement} container - El elemento DOM donde se renderizar√° el formulario.
         * @param {Object} [childToEdit=null] - Objeto hijo a editar, si es modo edici√≥n.
         */
        function renderAddChildForm(container, childToEdit = null) {
            const isEditMode = !!childToEdit;
            const formHtml = `
                <div class="bg-white bg-opacity-80 rounded-lg shadow-xl p-6 md:p-8 max-w-lg mx-auto">
                    <h2 class="text-xl md:text-2xl font-semibold text-gray-800 mb-6">${isEditMode ? 'Editar Perfil del Hijo' : 'A√±adir Nuevo Hijo'}</h2>
                    <form id="child-form" class="space-y-4">
                        <div>
                            <label for="name" class="block text-gray-700 text-sm font-bold mb-2">
                                Nombre del Hijo:
                            </label>
                            <input
                                type="text"
                                id="name"
                                value="${childToEdit ? childToEdit.name : ''}"
                                class="shadow appearance-none border rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-400"
                                placeholder="Ej. Juanito"
                                required
                            />
                        </div>
                        <div>
                            <label for="dob" class="block text-gray-700 text-sm font-bold mb-2">
                                Fecha de Nacimiento:
                            </label>
                            <input
                                type="date"
                                id="dob"
                                value="${childToEdit ? childToEdit.dob : ''}"
                                class="shadow appearance-none border rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-400"
                                required
                            />
                        </div>
                        <div>
                            <label for="photoURL" class="block text-gray-700 text-sm font-bold mb-2">
                                URL de la Foto (opcional):
                            </label>
                            <input
                                type="url"
                                id="photoURL"
                                value="${childToEdit ? childToEdit.photoURL : ''}"
                                class="shadow appearance-none border rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-400"
                                placeholder="https://ejemplo.com/foto.jpg"
                            />
                        </div>
                        <p id="form-error" class="text-red-500 text-sm italic hidden"></p>
                        <div class="flex justify-end gap-4 mt-6">
                            <button type="button" id="cancel-child-button"
                                class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out">
                                Cancelar
                            </button>
                            <button type="submit" id="save-child-button"
                                class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out flex items-center gap-2">
                                <span id="save-child-loading-spinner" class="hidden animate-spin h-5 w-5 text-white">
                                    <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                                </span>
                                <span id="save-child-button-text">${isEditMode ? 'Actualizar Perfil' : 'A√±adir Hijo'}</span>
                            </button>
                        </div>
                    </form>
                </div>
            `;
            container.innerHTML = formHtml;

            const nameInput = document.getElementById('name');
            const dobInput = document.getElementById('dob');
            const photoURLInput = document.getElementById('photoURL');
            const formError = document.getElementById('form-error');
            const saveButton = document.getElementById('save-child-button');
            const saveButtonText = document.getElementById('save-child-button-text');
            const saveButtonSpinner = document.getElementById('save-child-loading-spinner');

            document.getElementById('child-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                formError.classList.add('hidden');
                formError.textContent = '';

                const name = nameInput.value;
                const dob = dobInput.value;
                const photoURL = photoURLInput.value;

                if (!name || !dob) {
                    formError.textContent = 'Por favor, completa todos los campos requeridos.';
                    formError.classList.remove('hidden');
                    return;
                }

                saveButton.disabled = true;
                saveButtonSpinner.classList.remove('hidden');
                saveButtonText.textContent = 'Guardando...';

                try {
                    const childrenColRef = collection(db, `artifacts/${appId}/users/${userId}/children`);
                    const childData = { name, dob, photoURL };

                    if (isEditMode) {
                        const childDocRef = doc(db, `artifacts/${appId}/users/${userId}/children`, childToEdit.id);
                        await updateDoc(childDocRef, childData);
                        showMessage("√âxito", "Perfil del hijo actualizado correctamente.");
                        // Actualiza el hijo seleccionado si es el que se est√° editando
                        selectedChild = { id: childToEdit.id, ...childData };
                        currentPage = 'childProfile'; // Vuelve al perfil del hijo despu√©s de actualizar
                    } else {
                        await addDoc(childrenColRef, childData);
                        showMessage("√âxito", "Perfil del hijo a√±adido correctamente.");
                        currentPage = 'dashboard';
                    }
                    renderApp(); // Vuelve a renderizar la aplicaci√≥n para reflejar los cambios
                } catch (err) {
                    console.error("Error adding/updating child:", err);
                    formError.textContent = `Error al guardar el perfil: ${err.message}`;
                    formError.classList.remove('hidden');
                } finally {
                    saveButton.disabled = false;
                    saveButtonSpinner.classList.add('hidden');
                    saveButtonText.textContent = isEditMode ? 'Actualizar Perfil' : 'A√±adir Hijo';
                }
            });

            document.getElementById('cancel-child-button').addEventListener('click', () => {
                // Si es modo edici√≥n, regresa al perfil del hijo, de lo contrario, al dashboard
                currentPage = isEditMode ? 'childProfile' : 'dashboard';
                renderApp();
            });
        }

        // --- Componente Child Profile View ---
        /**
         * Renderiza la vista detallada del perfil de un hijo.
         * @param {HTMLElement} container - El elemento DOM donde se renderizar√° el perfil.
         * @param {Object} child - El objeto hijo cuyos detalles se mostrar√°n.
         */
        function renderChildProfile(container, child) {
            const profileHtml = `
                <div class="bg-white bg-opacity-80 rounded-lg shadow-xl p-6 md:p-8 max-w-4xl mx-auto">
                    <div class="flex items-center mb-6">
                        <button id="back-button"
                            class="flex items-center text-blue-600 hover:text-blue-800 font-semibold transition duration-300 mr-4">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth="2">
                                <path strokeLinecap="round" strokeLinejoin="round" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                            </svg>
                            Volver
                        </button>
                        <img src="${child.photoURL || `https://placehold.co/80x80/AEC6CF/FFFFFF?text=${child.name.charAt(0).toUpperCase()}`}"
                            alt="${child.name}"
                            class="w-20 h-20 rounded-full object-cover mr-4 border-2 border-blue-400 shadow-sm"
                            onerror="this.src='https://placehold.co/80x80/AEC6CF/FFFFFF?text=${child.name.charAt(0).toUpperCase()}'"
                        />
                        <h2 class="text-xl md:text-2xl font-bold text-gray-800">${child.name}</h2>
                    </div>

                    <div class="flex justify-end gap-4 mb-6">
                        <button id="edit-profile-button"
                            class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300">
                            Editar Perfil
                        </button>
                        <button id="delete-profile-button"
                            class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300">
                            Eliminar Perfil
                        </button>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <div id="behavior-calendar-container">
                            <h3 class="text-xl font-semibold text-gray-800 mb-4">Registro de Comportamiento</h3>
                            <!-- El calendario se renderizar√° aqu√≠ -->
                        </div>
                        <div id="behavior-statistics-container">
                            <h3 class="text-xl font-semibold text-gray-800 mb-4">Estad√≠sticas de Comportamiento</h3>
                            <!-- Las estad√≠sticas se renderizar√°n aqu√≠ -->
                        </div>
                    </div>
                </div>
            `;
            container.innerHTML = profileHtml;

            // Manejadores de eventos
            document.getElementById('back-button').addEventListener('click', () => {
                currentPage = 'dashboard';
                selectedChild = null; // Limpia el hijo seleccionado
                renderApp();
            });

            document.getElementById('edit-profile-button').addEventListener('click', () => {
                // Abre el formulario de a√±adir/editar hijo en un modal simple
                const modalContainer = document.createElement('div');
                modalContainer.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50';
                document.body.appendChild(modalContainer);

                // Renderiza el formulario de edici√≥n dentro del modal
                renderAddChildForm(modalContainer, child);
                const closeEditModal = () => document.body.removeChild(modalContainer);

                // Sobrescribe los manejadores de cancelar/guardar del formulario para cerrar el modal
                document.getElementById('cancel-child-button').onclick = closeEditModal;
                const formElement = document.getElementById('child-form');
                const originalSubmitHandler = formElement.onsubmit; // Guarda el manejador original si lo hubiera
                formElement.onsubmit = async (e) => {
                    e.preventDefault(); // Previene la recarga por defecto
                    const nameInput = document.getElementById('name');
                    const dobInput = document.getElementById('dob');
                    const photoURLInput = document.getElementById('photoURL');
                    const formError = document.getElementById('form-error');

                    const name = nameInput.value;
                    const dob = dobInput.value;
                    const photoURL = photoURLInput.value;

                    if (!name || !dob) {
                        formError.textContent = 'Por favor, completa todos los campos requeridos.';
                        formError.classList.remove('hidden');
                        return;
                    }

                    // Ejecuta la l√≥gica de guardado (similar a la original en AddChildForm)
                    try {
                        const childDocRef = doc(db, `artifacts/${appId}/users/${userId}/children`, child.id);
                        const childData = { name, dob, photoURL };
                        await updateDoc(childDocRef, childData);
                        showMessage("√âxito", "Perfil del hijo actualizado correctamente.");
                        selectedChild = { id: child.id, ...childData }; // Actualiza el hijo seleccionado
                        closeEditModal(); // Cierra el modal solo si el guardado fue exitoso
                        renderApp(); // Re-renderiza para actualizar el perfil en la vista
                    } catch (err) {
                        console.error("Error updating child:", err);
                        formError.textContent = `Error al actualizar el perfil: ${err.message}`;
                        formError.classList.remove('hidden');
                    }
                };
            });


            document.getElementById('delete-profile-button').addEventListener('click', () => {
                renderConfirmationModal(
                    "Confirmar Eliminaci√≥n",
                    `¬øEst√°s seguro de que quieres eliminar el perfil de ${child.name} y todos sus registros de comportamiento? Esta acci√≥n es irreversible.`,
                    async () => {
                        try {
                            // Primero elimina todos los registros de comportamiento asociados al hijo
                            const behaviorQuery = query(
                                collection(db, `artifacts/${appId}/users/${userId}/behavior`),
                                where("childId", "==", child.id)
                            );
                            const behaviorSnapshot = await getDocs(behaviorQuery);
                            const deletePromises = behaviorSnapshot.docs.map(doc => deleteDoc(doc.ref));
                            await Promise.all(deletePromises);

                            // Luego elimina el perfil del hijo
                            const childDocRef = doc(db, `artifacts/${appId}/users/${userId}/children`, child.id);
                            await deleteDoc(childDocRef);
                            showMessage("√âxito", "Hijo y sus registros de comportamiento eliminados correctamente.");
                            currentPage = 'dashboard';
                            selectedChild = null;
                            renderApp(); // Vuelve al dashboard despu√©s de eliminar
                        } catch (error) {
                            console.error("Error deleting child and behaviors:", error);
                            showMessage("Error", `No se pudo eliminar el perfil: ${error.message}`);
                        }
                    },
                    () => { /* Acci√≥n de cancelar, no hace nada */ }
                );
            });

            // Escucha cambios en los registros de comportamiento para este hijo en tiempo real
            const behaviorColRef = collection(db, `artifacts/${appId}/users/${userId}/behavior`);
            const q = query(behaviorColRef, where("childId", "==", child.id));
            onSnapshot(q, (snapshot) => {
                const records = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                // Re-renderiza solo el calendario y las estad√≠sticas si el hijo actual est√° seleccionado
                if (selectedChild && selectedChild.id === child.id) {
                    renderBehaviorCalendar(document.getElementById('behavior-calendar-container'), records);
                    renderBehaviorStatistics(document.getElementById('behavior-statistics-container'), records);
                }
            }, (error) => {
                console.error("Error fetching behavior records:", error);
                showMessage("Error de Datos", "No se pudieron cargar los registros de comportamiento.");
            });

            // Renderiza el calendario y las estad√≠sticas inicialmente
            renderBehaviorCalendar(document.getElementById('behavior-calendar-container'), []); // Se llenar√° con onSnapshot
            renderBehaviorStatistics(document.getElementById('behavior-statistics-container'), []); // Se llenar√° con onSnapshot
        }

        // --- Componente Behavior Calendar ---
        /**
         * Renderiza el calendario de comportamiento para un mes dado.
         * @param {HTMLElement} container - El elemento DOM donde se renderizar√° el calendario.
         * @param {Array<Object>} behaviorRecords - Registros de comportamiento del hijo.
         */
        function renderBehaviorCalendar(container, behaviorRecords) {
            const monthNames = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];
            const dayNames = ["Lun", "Mar", "Mi√©", "Jue", "Vie", "S√°b", "Dom"];

            const daysInMonth = (year, month) => new Date(year, month + 1, 0).getDate();
            const firstDayOfMonth = (year, month) => new Date(year, month, 1).getDay(); // 0 para domingo, 1 para lunes

            const totalDays = daysInMonth(currentCalendarMonth.getFullYear(), currentCalendarMonth.getMonth());
            const firstDay = firstDayOfMonth(currentCalendarMonth.getFullYear(), currentCalendarMonth.getMonth());
            const adjustedFirstDay = (firstDay === 0) ? 6 : firstDay - 1; // Ajusta para que la semana empiece en lunes

            let calendarDaysHtml = '';
            // Espacios en blanco para los d√≠as iniciales del mes
            for (let i = 0; i < adjustedFirstDay; i++) {
                calendarDaysHtml += `<div class="p-2"></div>`;
            }

            // D√≠as del mes
            for (let day = 1; day <= totalDays; day++) {
                const date = new Date(currentCalendarMonth.getFullYear(), currentCalendarMonth.getMonth(), day);
                const dateString = date.toISOString().split('T')[0]; // Formato YYYY-MM-DD
                const dailyRecords = behaviorRecords.filter(record => record.date === dateString);

                let bgColor = 'bg-white';
                let icon = null;

                // Resume el comportamiento para el icono del calendario: Equivocado > Regular > Bueno
                if (dailyRecords.some(rec => rec.type === 'Equivocado')) {
                    bgColor = 'bg-red-200';
                    icon = 'üëé';
                } else if (dailyRecords.some(rec => rec.type === 'Regular')) {
                    bgColor = 'bg-yellow-200';
                    icon = 'ÔøΩ';
                } else if (dailyRecords.some(rec => rec.type === 'Bueno')) {
                    bgColor = 'bg-green-200';
                    icon = 'üëç';
                }

                const today = new Date();
                const isToday = date.toDateString() === today.toDateString();

                calendarDaysHtml += `
                    <div class="p-2 rounded-lg flex flex-col items-center justify-center cursor-pointer hover:bg-blue-100 transition-colors duration-200 ${bgColor} ${isToday ? 'border-2 border-blue-500 shadow-md' : ''}"
                         data-date="${dateString}">
                        <span class="font-medium text-gray-800">${day}</span>
                        ${icon ? `<span class="text-xl mt-1">${icon}</span>` : ''}
                    </div>
                `;
            }

            const calendarHtml = `
                <div class="bg-blue-50 p-4 rounded-lg shadow-inner">
                    <div class="flex justify-between items-center mb-4">
                        <button id="prev-month-button" class="p-2 rounded-full hover:bg-blue-200">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-blue-700" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth="2">
                                <path strokeLinecap="round" strokeLinejoin="round" d="M15 19l-7-7 7-7" />
                            </svg>
                        </button>
                        <h4 class="text-lg font-semibold text-blue-800">
                            ${monthNames[currentCalendarMonth.getMonth()]} ${currentCalendarMonth.getFullYear()}
                        </h4>
                        <button id="next-month-button" class="p-2 rounded-full hover:bg-blue-200">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-blue-700" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth="2">
                                <path strokeLinecap="round" strokeLinejoin="round" d="M9 5l7 7-7 7" />
                            </svg>
                        </button>
                    </div>
                    <div class="grid grid-cols-7 text-center text-sm font-semibold text-gray-600 mb-2">
                        ${dayNames.map(day => `<div class="py-2">${day}</div>`).join('')}
                    </div>
                    <div class="grid grid-cols-7 gap-1">
                        ${calendarDaysHtml}
                    </div>
                </div>
            `;
            container.innerHTML = calendarHtml;

            // A√±ade manejadores de eventos a cada celda de d√≠a
            container.querySelectorAll('[data-date]').forEach(dayDiv => {
                dayDiv.addEventListener('click', () => {
                    const date = new Date(dayDiv.dataset.date + 'T12:00:00Z'); // A√±ade hora para evitar problemas de zona horaria
                    const recordsForDate = behaviorRecords.filter(record => record.date === dayDiv.dataset.date);
                    renderBehaviorFormModal(date, recordsForDate);
                });
            });

            // Manejadores para cambiar de mes
            document.getElementById('prev-month-button').addEventListener('click', () => {
                currentCalendarMonth.setMonth(currentCalendarMonth.getMonth() - 1);
                renderApp(); // Vuelve a renderizar toda la aplicaci√≥n para actualizar el calendario
            });
            document.getElementById('next-month-button').addEventListener('click', () => {
                currentCalendarMonth.setMonth(currentCalendarMonth.getMonth() + 1);
                renderApp(); // Vuelve a renderizar toda la aplicaci√≥n para actualizar el calendario
            });
        }


        // --- Componente Behavior Form Modal ---
        /**
         * Renderiza el modal para registrar o ver comportamientos diarios.
         * @param {Date} selectedDate - La fecha seleccionada en el calendario.
         * @param {Array<Object>} dailyRecords - Registros de comportamiento para la fecha seleccionada.
         */
        function renderBehaviorFormModal(selectedDate, dailyRecords) {
            const modalContainer = document.createElement('div');
            modalContainer.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50';
            document.body.appendChild(modalContainer);

            // Ordena los registros diarios por timestamp para una visualizaci√≥n consistente
            const sortedDailyRecords = dailyRecords.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));

            let existingRecordsHtml = '';
            if (sortedDailyRecords.length > 0) {
                existingRecordsHtml = `
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4 max-h-48 overflow-y-auto">
                        <h4 class="text-md font-semibold text-gray-800 mb-2">Comportamientos del d√≠a ya registrados:</h4>
                        ${sortedDailyRecords.map(record => `
                            <div class="border-b border-blue-100 last:border-b-0 py-2 flex justify-between items-center">
                                <div>
                                    <p class="text-lg font-bold text-blue-700">Tipo: ${record.type}</p>
                                    <p class="text-gray-700 italic text-sm">Comentario: ${record.comment || 'Ninguno'}</p>
                                    <p class="text-gray-500 text-xs mt-1">Hora: ${new Date(record.timestamp).toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' })}</p>
                                </div>
                                <button type="button" class="text-red-500 hover:text-red-700 p-1 rounded-full hover:bg-red-100 transition-colors delete-record-button"
                                    data-record-id="${record.id}" title="Eliminar registro">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth="2">
                                        <path strokeLinecap="round" strokeLinejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                    </svg>
                                </button>
                            </div>
                        `).join('')}
                    </div>
                `;
            }

            modalContainer.innerHTML = `
                <div class="bg-white p-6 rounded-lg shadow-xl max-w-md w-full animate-fade-in-up">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">
                        Registrar Comportamiento para ${selectedDate.toLocaleDateString('es-ES')}
                    </h3>

                    ${existingRecordsHtml}

                    <form id="behavior-form" class="space-y-4">
                        <div>
                            <label class="block text-gray-700 text-sm font-bold mb-2">
                                Tipo de Comportamiento (nuevo registro):
                            </label>
                            <div class="flex gap-3 flex-wrap">
                                <button type="button" class="type-button py-2 px-4 rounded-lg font-semibold border-2 bg-green-100 text-green-700 border-green-200 hover:bg-green-200" data-type="Bueno">Bueno</button>
                                <button type="button" class="type-button py-2 px-4 rounded-lg font-semibold border-2 bg-yellow-100 text-yellow-700 border-yellow-200 hover:bg-yellow-200" data-type="Regular">Regular</button>
                                <button type="button" class="type-button py-2 px-4 rounded-lg font-semibold border-2 bg-red-100 text-red-700 border-red-200 hover:bg-red-200" data-type="Equivocado">Equivocado</button>
                            </div>
                        </div>
                        <div>
                            <label for="comment-input" class="block text-gray-700 text-sm font-bold mb-2">
                                Comentario (opcional para nuevo registro):
                            </label>
                            <textarea
                                id="comment-input"
                                rows="3"
                                class="shadow appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-400"
                                placeholder="A√±ade detalles sobre el comportamiento..."
                            ></textarea>
                        </div>
                        <p id="behavior-form-error" class="text-red-500 text-sm italic hidden"></p>
                        <div class="flex justify-between gap-2 mt-6">
                            <button type="button" id="close-behavior-modal"
                                class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg shadow-md transition duration-300">
                                Cerrar
                            </button>
                            <button type="submit" id="add-behavior-record"
                                class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 flex items-center gap-2">
                                <span id="behavior-loading-spinner" class="hidden animate-spin h-5 w-5 text-white">
                                    <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                                </span>
                                A√±adir Registro
                            </button>
                        </div>
                    </form>
                </div>
            `;

            let currentType = ''; // Estado local para el tipo de comportamiento seleccionado
            const commentInput = modalContainer.querySelector('#comment-input');
            const behaviorFormError = modalContainer.querySelector('#behavior-form-error');
            const addButton = modalContainer.querySelector('#add-behavior-record');
            const addSpinner = modalContainer.querySelector('#behavior-loading-spinner');

            // Manejadores de eventos para los botones de tipo de comportamiento
            modalContainer.querySelectorAll('.type-button').forEach(button => {
                button.addEventListener('click', function() {
                    // Restablece el estilo de todos los botones de tipo
                    modalContainer.querySelectorAll('.type-button').forEach(btn => {
                        const typeClass = btn.dataset.type;
                        if (typeClass === 'Bueno') btn.className = 'type-button py-2 px-4 rounded-lg font-semibold border-2 bg-green-100 text-green-700 border-green-200 hover:bg-green-200';
                        if (typeClass === 'Regular') btn.className = 'type-button py-2 px-4 rounded-lg font-semibold border-2 bg-yellow-100 text-yellow-700 border-yellow-200 hover:bg-yellow-200';
                        if (typeClass === 'Equivocado') btn.className = 'type-button py-2 px-4 rounded-lg font-semibold border-2 bg-red-100 text-red-700 border-red-200 hover:bg-red-200';
                    });
                    // Aplica el estilo al bot√≥n seleccionado
                    currentType = this.dataset.type;
                    const typeClass = this.dataset.type;
                    if (typeClass === 'Bueno') this.className = 'type-button py-2 px-4 rounded-lg font-semibold border-2 bg-green-500 text-white border-green-600';
                    if (typeClass === 'Regular') this.className = 'type-button py-2 px-4 rounded-lg font-semibold border-2 bg-yellow-500 text-gray-900 border-yellow-600';
                    if (typeClass === 'Equivocado') this.className = 'type-button py-2 px-4 rounded-lg font-semibold border-2 bg-red-500 text-white border-red-600';
                });
            });

            // Manejador para el env√≠o del formulario de comportamiento
            modalContainer.querySelector('#behavior-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                behaviorFormError.classList.add('hidden');
                behaviorFormError.textContent = '';

                if (!currentType) {
                    behaviorFormError.textContent = 'Por favor, selecciona un tipo de comportamiento.';
                    behaviorFormError.classList.remove('hidden');
                    return;
                }

                addButton.disabled = true;
                addSpinner.classList.remove('hidden');

                try {
                    const behaviorColRef = collection(db, `artifacts/${appId}/users/${userId}/behavior`);
                    const recordData = {
                        childId: selectedChild.id,
                        date: selectedDate.toISOString().split('T')[0], // Formato YYYY-MM-DD
                        type: currentType,
                        comment: commentInput.value,
                        timestamp: new Date().toISOString(), // Para ordenar y seguimiento
                    };
                    await addDoc(behaviorColRef, recordData); // Siempre a√±ade un nuevo registro
                    showMessage("√âxito", "Registro de comportamiento guardado.");
                    
                    // Limpia el formulario para la siguiente entrada
                    currentType = '';
                    commentInput.value = '';
                    modalContainer.querySelectorAll('.type-button').forEach(btn => {
                        const typeClass = btn.dataset.type;
                        if (typeClass === 'Bueno') btn.className = 'type-button py-2 px-4 rounded-lg font-semibold border-2 bg-green-100 text-green-700 border-green-200 hover:bg-green-200';
                        if (typeClass === 'Regular') btn.className = 'type-button py-2 px-4 rounded-lg font-semibold border-2 bg-yellow-100 text-yellow-700 border-yellow-200 hover:bg-yellow-200';
                        if (typeClass === 'Equivocado') btn.className = 'type-button py-2 px-4 rounded-lg font-semibold border-2 bg-red-100 text-red-700 border-red-200 hover:bg-red-200';
                    });
                    
                    // Re-renderiza toda la aplicaci√≥n para actualizar el calendario, las estad√≠sticas
                    // y los registros diarios en el modal (que se reabrir√° con los datos actualizados).
                    // Para que el modal se cierre y reabra con los datos frescos, debemos quitarlo y recrearlo.
                    modalContainer.remove(); // Quita el modal actual
                    // El onSnapshot en ChildProfile eventualmente llamar√° a renderApp,
                    // y el clic en el d√≠a del calendario lo reabrir√° con los datos actualizados.
                    // Para una experiencia m√°s fluida, podr√≠amos llamar directamente a la funci√≥n de apertura
                    // del modal si no queremos un renderApp completo.
                    const updatedRecordsForDate = children.find(c => c.id === selectedChild.id) // Encuentra el hijo actualizado
                                                    ? (children.find(c => c.id === selectedChild.id).behaviorRecords || []).filter(rec => rec.date === selectedDate.toISOString().split('T')[0])
                                                    : [];
                    // Como los `behaviorRecords` son actualizados por `onSnapshot` globalmente,
                    // podemos simplemente reabrir el modal y se autofiltrar√°.
                    // Sin embargo, para evitar un doble renderizado o latencia, lo mejor es
                    // que `renderApp` se encargue de todo. Por ahora, forzamos un re-render completo.
                    // Una implementaci√≥n m√°s avanzada manejar√≠a el estado del modal y los datos directamente
                    // sin un `renderApp` completo aqu√≠.
                    renderApp(); // Esto recargar√° ChildProfile y activar√° la visualizaci√≥n del calendario
                    // y sus propios onSnapshots, haciendo que el modal se reabra con datos frescos.

                } catch (err) {
                    console.error("Error saving behavior record:", err);
                    behaviorFormError.textContent = `Error al guardar el registro: ${err.message}`;
                    behaviorFormError.classList.remove('hidden');
                } finally {
                    addButton.disabled = false;
                    addSpinner.classList.add('hidden');
                }
            });

            // Manejador para cerrar el modal de comportamiento
            modalContainer.querySelector('#close-behavior-modal').addEventListener('click', () => {
                modalContainer.remove();
            });

            // Manejadores para eliminar registros de comportamiento individuales
            modalContainer.querySelectorAll('.delete-record-button').forEach(button => {
                button.addEventListener('click', async function() {
                    const recordIdToDelete = this.dataset.recordId;
                    addButton.disabled = true; // Deshabilita los botones durante la operaci√≥n
                    addSpinner.classList.add('hidden'); // Oculta el spinner de a√±adir si est√° visible, muestra el de eliminar si se desea

                    try {
                        const recordDocRef = doc(db, `artifacts/${appId}/users/${userId}/behavior`, recordIdToDelete);
                        await deleteDoc(recordDocRef);
                        showMessage("√âxito", "Registro de comportamiento eliminado.");
                        
                        // Despu√©s de eliminar, re-renderiza toda la aplicaci√≥n para que se actualice el UI
                        // El onSnapshot en ChildProfile se encargar√° de actualizar la lista de records.
                        modalContainer.remove(); // Cierra el modal actual
                        renderApp(); // Re-renderiza para actualizar el perfil y el calendario/estad√≠sticas
                        // El modal se reabrir√° autom√°ticamente al renderizarse la fecha del calendario si sigue seleccionada.

                    } catch (err) {
                        console.error("Error deleting behavior record:", err);
                        showMessage("Error", `Error al eliminar el registro: ${err.message}`);
                    } finally {
                        addButton.disabled = false;
                        // addSpinner.classList.add('hidden'); // Asegura que el spinner de a√±adir est√© oculto
                    }
                });
            });
        }


        // --- Componente Behavior Statistics ---
        /**
         * Renderiza las estad√≠sticas de comportamiento.
         * @param {HTMLElement} container - El elemento DOM donde se renderizar√°n las estad√≠sticas.
         * @param {Array<Object>} records - Todos los registros de comportamiento del hijo.
         */
        function renderBehaviorStatistics(container, records) {
            let currentFilter = 'week'; // Filtro predeterminado al cargar el componente

            // Funci√≥n para calcular y renderizar las estad√≠sticas seg√∫n el filtro actual
            const updateStatsDisplay = () => {
                const now = new Date();
                let filteredRecords = [];

                records.forEach(record => {
                    const recordDate = new Date(record.date);
                    if (isNaN(recordDate.getTime())) { // Usa .getTime() para una validaci√≥n m√°s robusta
                        console.warn(`Invalid date format for record: ${record.date}`);
                        return;
                    }

                    if (currentFilter === 'day') {
                        // Filtra para el d√≠a actual
                        if (recordDate.getDate() === now.getDate() &&
                            recordDate.getMonth() === now.getMonth() &&
                            recordDate.getFullYear() === now.getFullYear()) {
                            filteredRecords.push(record);
                        }
                    } else if (currentFilter === 'week') {
                        // Inicio de la semana actual (Lunes)
                        const startOfWeek = new Date(now);
                        startOfWeek.setDate(now.getDate() - (now.getDay() === 0 ? 6 : now.getDay() - 1)); // Ajusta para que la semana comience en lunes
                        startOfWeek.setHours(0, 0, 0, 0);

                        // Fin de la semana actual (Domingo)
                        const endOfWeek = new Date(startOfWeek);
                        endOfWeek.setDate(startOfWeek.getDate() + 6);
                        endOfWeek.setHours(23, 59, 59, 999);

                        if (recordDate >= startOfWeek && recordDate <= endOfWeek) {
                            filteredRecords.push(record);
                        }
                    } else if (currentFilter === 'month') {
                        if (recordDate.getMonth() === now.getMonth() && recordDate.getFullYear() === now.getFullYear()) {
                            filteredRecords.push(record);
                        }
                    } else if (currentFilter === 'year') {
                        if (recordDate.getFullYear() === now.getFullYear()) {
                            filteredRecords.push(record);
                        }
                    }
                });

                const counts = { Bueno: 0, Regular: 0, Equivocado: 0 };
                filteredRecords.forEach(record => {
                    if (counts.hasOwnProperty(record.type)) {
                        counts[record.type]++;
                    }
                });

                const total = filteredRecords.length;
                const goodPercentage = total > 0 ? (counts.Bueno / total) * 100 : 0;
                const regularPercentage = total > 0 ? (counts.Regular / total) * 100 : 0;
                const wrongPercentage = total > 0 ? (counts.Equivocado / total) * 100 : 0;

                const statsContentElement = document.getElementById('stats-content');
                if (!statsContentElement) return;

                statsContentElement.innerHTML = `
                    <div class="space-y-4">
                        ${total === 0 ? `
                            <p class="text-center text-gray-600 py-4">No hay registros de comportamiento para este per√≠odo.</p>
                        ` : `
                            <div class="flex items-center gap-3">
                                <div class="w-1/4 text-gray-700 font-semibold">Bueno:</div>
                                <div class="w-3/4 bg-green-300 rounded-full h-8 flex items-center overflow-hidden">
                                    <div class="bg-green-600 h-full rounded-full text-white text-xs font-bold flex items-center justify-center transition-all duration-500 ease-out"
                                        style="width: ${goodPercentage}%">
                                        ${counts.Bueno > 0 ? `${goodPercentage.toFixed(0)}%` : ''}
                                    </div>
                                    ${counts.Bueno === 0 ? `<span class="pl-3 text-gray-800">${goodPercentage.toFixed(0)}%</span>` : ''}
                                </div>
                            </div>
                            <div class="flex items-center gap-3">
                                <div class="w-1/4 text-gray-700 font-semibold">Regular:</div>
                                <div class="w-3/4 bg-yellow-300 rounded-full h-8 flex items-center overflow-hidden">
                                    <div class="bg-yellow-600 h-full rounded-full text-gray-900 text-xs font-bold flex items-center justify-center transition-all duration-500 ease-out"
                                        style="width: ${regularPercentage}%">
                                        ${counts.Regular > 0 ? `${regularPercentage.toFixed(0)}%` : ''}
                                    </div>
                                    ${counts.Regular === 0 ? `<span class="pl-3 text-gray-800">${regularPercentage.toFixed(0)}%</span>` : ''}
                                </div>
                            </div>
                            <div class="flex items-center gap-3">
                                <div class="w-1/4 text-gray-700 font-semibold">Equivocado:</div>
                                <div class="w-3/4 bg-red-300 rounded-full h-8 flex items-center overflow-hidden">
                                    <div class="bg-red-600 h-full rounded-full text-white text-xs font-bold flex items-center justify-center transition-all duration-500 ease-out"
                                        style="width: ${wrongPercentage}%">
                                        ${counts.Equivocado > 0 ? `${wrongPercentage.toFixed(0)}%` : ''}
                                    </div>
                                    ${counts.Equivocado === 0 ? `<span class="pl-3 text-gray-800">${wrongPercentage.toFixed(0)}%</span>` : ''}
                                </div>
                            </div>
                            <div class="mt-6 pt-4 border-t border-gray-200 text-center text-lg font-bold text-gray-800">
                                Total de Registros: ${total}
                            </div>
                        `}
                    </div>
                `;
            };

            const filterButtonsHtml = `
                <div class="flex justify-around mb-4 bg-white p-2 rounded-lg shadow-sm">
                    <button id="filter-day" class="py-2 px-4 rounded-lg font-semibold transition-colors duration-200">D√≠a</button>
                    <button id="filter-week" class="py-2 px-4 rounded-lg font-semibold transition-colors duration-200">Semana</button>
                    <button id="filter-month" class="py-2 px-4 rounded-lg font-semibold transition-colors duration-200">Mes</button>
                    <button id="filter-year" class="py-2 px-4 rounded-lg font-semibold transition-colors duration-200">A√±o</button>
                </div>
                <div id="stats-content"></div> <!-- Contenedor para las estad√≠sticas reales -->
            `;
            container.innerHTML = `<div class="bg-blue-50 p-4 rounded-lg shadow-inner">${filterButtonsHtml}</div>`;

            // A√±ade manejadores de eventos para los botones de filtro
            const filterButtons = container.querySelectorAll('.bg-white button');
            filterButtons.forEach(button => {
                button.addEventListener('click', function() {
                    currentFilter = this.id.replace('filter-', ''); // Obtiene el filtro ('day', 'week', 'month', 'year')
                    // Actualiza el estilo de los botones para indicar cu√°l est√° activo
                    filterButtons.forEach(btn => {
                        if (btn.id === `filter-${currentFilter}`) {
                            btn.className = 'py-2 px-4 rounded-lg font-semibold transition-colors duration-200 bg-blue-500 text-white shadow-md';
                        } else {
                            btn.className = 'py-2 px-4 rounded-lg font-semibold transition-colors duration-200 text-blue-700 hover:bg-blue-100';
                        }
                    });
                    updateStatsDisplay(); // Recalcula y renderiza las estad√≠sticas con el nuevo filtro
                });
            });

            // Establece el estado inicial del bot√≥n activo y muestra las estad√≠sticas
            // Esto simula un clic para que se aplique el estilo inicial y se rendericen las estad√≠sticas
            container.querySelector(`#filter-${currentFilter}`).click();
        }


        // --- Inicializaci√≥n de Firebase y Listener de Autenticaci√≥n ---
        // Se ejecuta una vez que el DOM est√° completamente cargado
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                // Validaci√≥n de firebaseConfig.apiKey antes de inicializar la app
                if (!firebaseConfig.apiKey || firebaseConfig.apiKey === "TU_API_KEY_DE_FIREBASE") {
                    showMessage("Error de Configuraci√≥n", "La configuraci√≥n de Firebase est√° incompleta o es incorrecta. Por favor, reemplaza 'TU_API_KEY_DE_FIREBASE' y otros marcadores de posici√≥n con tus propias credenciales de Firebase en el c√≥digo fuente.");
                    loading = false;
                    renderApp(); // Renderiza la app para mostrar el error al usuario.
                    return; // Detiene la ejecuci√≥n si la API key no es v√°lida
                }

                // Inicializa la aplicaci√≥n Firebase
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // Escucha cambios en el estado de autenticaci√≥n
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        isAuthReady = true;
                        loading = false; // La autenticaci√≥n ha terminado
                    } else {
                        // Si no hay un usuario autenticado, intenta iniciar sesi√≥n an√≥nimamente
                        // __initial_auth_token es una variable global proporcionada por el entorno de Canvas.
                        // Si se ejecuta de forma independiente (ej. en GitHub Pages), no estar√° definida.
                        if (typeof __initial_auth_token === 'undefined') {
                            try {
                                const anonUserCredential = await signInAnonymously(auth);
                                userId = anonUserCredential.user.uid;
                                isAuthReady = true;
                            } catch (anonError) {
                                console.error("Error signing in anonymously:", anonError);
                                showMessage("Error de Autenticaci√≥n", "No se pudo iniciar sesi√≥n an√≥nimamente. Por favor, revisa tu clave API y configuraci√≥n de Firebase.");
                                isAuthReady = false;
                            } finally {
                                loading = false;
                            }
                        } else {
                            // Si se proporciona un token de autenticaci√≥n personalizado
                            try {
                                await signInWithCustomToken(auth, __initial_auth_token);
                            } catch (tokenError) {
                                console.error("Error signing in with custom token:", tokenError);
                                showMessage("Error de Autenticaci√≥n", "No se pudo iniciar sesi√≥n con el token proporcionado. Por favor, revisa tu clave API y configuraci√≥n de Firebase.");
                            } finally {
                                loading = false;
                            }
                        }
                    }
                    renderApp(); // Renderiza la aplicaci√≥n despu√©s de que se determine el estado de autenticaci√≥n

                    // Si Firebase y el usuario est√°n listos, suscribe a los cambios en los perfiles de los hijos
                    if (db && userId && isAuthReady) {
                        const childrenColRef = collection(db, `artifacts/${appId}/users/${userId}/children`);
                        onSnapshot(childrenColRef, (snapshot) => {
                            children = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                            renderApp(); // Vuelve a renderizar la aplicaci√≥n cada vez que los datos de los hijos cambian
                        }, (error) => {
                            console.error("Error fetching children:", error);
                            showMessage("Error de Datos", "No se pudieron cargar los perfiles de los hijos.");
                        });
                    }
                });
            } catch (error) {
                console.error("Failed to initialize Firebase:", error);
                showMessage("Error de Inicializaci√≥n", "No se pudo inicializar la aplicaci√≥n. Intente de nuevo. Aseg√∫rate de que tu configuraci√≥n de Firebase sea correcta.");
                loading = false; // Asegura que el estado de carga se establezca en false incluso en caso de error
                renderApp();
            }
        });
    </script>
</body>
</html>
